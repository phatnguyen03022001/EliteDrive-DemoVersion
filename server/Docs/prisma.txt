// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  GUEST
  CUSTOMER
  OWNER
  ADMIN
}

enum KYCStatus {
  NONE
  PENDING
  APPROVED
  REJECTED
}

enum BookingStatus {
  PENDING
  APPROVED
  REJECTED
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum TripStatus {
  UPCOMING
  ONGOING
  COMPLETED
}

enum DisputeStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum SettlementStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum CarStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

// ==================== USERS & AUTHENTICATION ====================

model User {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  email      String   @unique
  password   String
  phone      String?
  firstName  String?
  lastName   String?
  avatar     String?
  role       UserRole @default(GUEST)
  isVerified Boolean  @default(false)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  customerProfile CustomerProfile?
  ownerProfile    OwnerProfile?
  kyc             KYC?
  bookings        Booking[]
  payments        Payment[]
  reviews         Review[]
  wallet          Wallet?
  notifications   Notification[]
  trips           Trip[]
  disputes        Dispute[]
}

model CustomerProfile {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  userId          String    @unique @db.ObjectId
  licenseNumber   String?
  licenseExpiry   DateTime?
  licenseFrontUrl String?
  licenseBackUrl  String?
  dateOfBirth     DateTime?
  address         String?
  city            String?
  country         String?
  postalCode      String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OwnerProfile {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  userId             String   @unique @db.ObjectId
  companyName        String?
  taxId              String?
  bankAccountName    String?
  bankAccountNumber  String?
  bankCode           String?
  address            String?
  city               String?
  country            String?
  verificationStatus String   @default("pending")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  settlements  Settlement[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  cars         Car[]
  earnings     Earning[]
  transactions Transaction[]
}

// ==================== KYC & VERIFICATION ====================

model KYC {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  userId           String    @unique @db.ObjectId
  status           KYCStatus @default(NONE)
  documentType     String?
  documentNumber   String?
  documentFrontUrl String? // <--- Nên đặt tên rõ ràng hơn thay vì documentImageUrl
  documentBackUrl  String?
  faceImageUrl     String?
  verifiedAt       DateTime?
  rejectionReason  String?
  submittedAt      DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
}

// ==================== CARS & VEHICLES ====================

model Car {
  id                 String    @id @default(auto()) @map("_id") @db.ObjectId
  ownerId            String    @db.ObjectId
  name               String
  brand              String
  model              String
  year               Int
  licensePlate       String    @unique
  color              String?
  transmission       String?
  fuelType           String?
  status             CarStatus @default(DRAFT)
  seatCount          Int
  description        String?
  mainImageUrl       String?
  imageUrls          String[]
  categoryId         String?   @db.ObjectId
  locationId         String?   @db.ObjectId
  pricePerDay        Float
  pricePerHour       Float?
  insurance          Float?
  depositRequired    Float?
  isAvailable        Boolean   @default(true)
  totalTrips         Int       @default(0)
  averageRating      Float     @default(0)
  verificationStatus String    @default("pending")
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  owner        OwnerProfile   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  category     Category?      @relation(fields: [categoryId], references: [id])
  location     Location?      @relation(fields: [locationId], references: [id])
  documents    CarDocument[]
  pricing      Pricing[]
  calendar     Calendar[]
  bookings     Booking[]
  reviews      Review[]
  availability Availability[]
  trips        Trip[]

  @@index([ownerId])
  @@index([categoryId])
  @@index([locationId])
  @@index([verificationStatus])
}

model CarDocument {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  carId        String    @db.ObjectId
  documentType String
  documentUrl  String
  expiryDate   DateTime?
  uploadedAt   DateTime  @default(now())

  car Car @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@index([carId])
}

model Category {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   @unique
  description String?
  imageUrl    String?
  createdAt   DateTime @default(now())

  cars Car[]
}

model Location {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String   @unique
  address   String
  city      String
  latitude  Float?
  longitude Float?
  createdAt DateTime @default(now())

  cars Car[]
}

// ==================== PRICING & AVAILABILITY ====================

model Pricing {
  id                 String    @id @default(auto()) @map("_id") @db.ObjectId
  carId              String    @db.ObjectId
  pricePerDay        Float
  pricePerHour       Float?
  pricePerWeek       Float?
  pricePerMonth      Float?
  discountPercentage Float     @default(0)
  effectiveFrom      DateTime
  effectiveTo        DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  car Car @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@index([carId])
  @@index([effectiveFrom])
}

model Availability {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  carId         String   @db.ObjectId
  date          DateTime
  isAvailable   Boolean  @default(true)
  blockedReason String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  car Car @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@unique([carId, date])
  @@index([carId])
  @@index([date])
}

model Calendar {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  carId         String   @db.ObjectId
  date          DateTime
  isBlocked     Boolean  @default(false)
  blockedReason String?
  createdAt     DateTime @default(now())

  car Car @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@unique([carId, date])
  @@index([carId])
}

// ==================== BOOKINGS & TRIPS ====================

model Booking {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  customerId      String        @db.ObjectId
  carId           String        @db.ObjectId
  startDate       DateTime
  endDate         DateTime
  pickupLocation  String?
  dropoffLocation String?
  status          BookingStatus @default(PENDING)
  totalPrice      Float
  insurancePrice  Float?
  depositAmount   Float?
  discountAmount  Float?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  customer User      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  car      Car       @relation(fields: [carId], references: [id], onDelete: Cascade)
  payments Payment[]
  contract Contract?
  trip     Trip?
  disputes Dispute[]

  @@index([customerId])
  @@index([carId])
  @@index([status])
  @@index([startDate])
}

model Trip {
  id             String     @id @default(auto()) @map("_id") @db.ObjectId
  bookingId      String     @unique @db.ObjectId
  customerId     String     @db.ObjectId
  carId          String     @db.ObjectId
  status         TripStatus @default(UPCOMING)
  startOdometer  Int?
  endOdometer    Int?
  startFuelLevel Float?
  endFuelLevel   Float?
  checkinTime    DateTime?
  checkoutTime   DateTime?
  pickupNotes    String?
  dropoffNotes   String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  booking  Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customer User      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  car      Car       @relation(fields: [carId], references: [id], onDelete: Cascade)
  incident Incident?

  @@index([customerId])
  @@index([carId])
  @@index([status])
}

// ==================== PAYMENTS & WALLET ====================
model Payment {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  bookingId     String?       @db.ObjectId // ❗ optional
  userId        String        @db.ObjectId
  walletId      String?       @db.ObjectId // ❗ thêm
  amount        Float
  paymentMethod String
  transactionId String?       @unique
  status        PaymentStatus @default(PENDING)
  paidAt        DateTime?
  refundedAt    DateTime?
  failureReason String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  booking Booking? @relation(fields: [bookingId], references: [id])
  user    User     @relation(fields: [userId], references: [id])
  wallet  Wallet?  @relation(fields: [walletId], references: [id])

  @@index([userId])
  @@index([status])
}

model Wallet {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @unique @db.ObjectId
  balance   Float    @default(0)
  currency  String   @default("VND")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]
  payments     Payment[]
}

model WalletTransaction {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  walletId    String   @db.ObjectId
  amount      Float
  type        String
  description String?
  createdAt   DateTime @default(now())

  wallet Wallet  @relation(fields: [walletId], references: [id], onDelete: Cascade)
  refund Refund?

  @@index([walletId])
  @@index([createdAt])
}

model Refund {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  transactionId String        @unique @db.ObjectId
  bookingId     String?       @db.ObjectId
  amount        Float
  reason        String?
  status        PaymentStatus @default(PENDING)
  processedAt   DateTime?
  createdAt     DateTime      @default(now())

  transaction WalletTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

// ==================== CONTRACTS ====================

model Contract {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  bookingId         String    @unique @db.ObjectId
  content           String?
  customerSignedAt  DateTime?
  customerSignature String?
  ownerSignedAt     DateTime?
  status            String    @default("pending")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}

// ==================== REVIEWS & RATINGS ====================

model Review {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  bookingId  String?  @db.ObjectId
  customerId String   @db.ObjectId
  carId      String   @db.ObjectId
  rating     Int
  title      String?
  content    String?
  images     String[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer User @relation(fields: [customerId], references: [id], onDelete: Cascade)
  car      Car  @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([carId])
  @@index([rating])
}

// ==================== BLOG & CONTENT ====================

model Blog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  slug      String   @unique
  title     String
  content   String
  excerpt   String?
  imageUrl  String?
  published Boolean  @default(false)
  viewCount Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([published])
}

// ==================== PROMOTIONS ====================

model Promotion {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  code             String   @unique
  description      String?
  discountType     String
  discountValue    Float
  maxUses          Int?
  usedCount        Int      @default(0)
  minBookingAmount Float?
  startDate        DateTime
  endDate          DateTime
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([isActive])
  @@index([startDate])
}

// ==================== DISPUTES & INCIDENTS ====================

model Dispute {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  bookingId   String?       @db.ObjectId
  booking     Booking?      @relation(fields: [bookingId], references: [id])
  initiatedBy String        @db.ObjectId
  title       String
  description String?
  attachments String[]
  status      DisputeStatus @default(OPEN)
  resolution  String?
  resolvedAt  DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  initiator       User             @relation(fields: [initiatedBy], references: [id], onDelete: Cascade)
  disputeMessages DisputeMessage[]

  @@index([initiatedBy])
  @@index([status])
}

model DisputeMessage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  disputeId String   @db.ObjectId
  senderId  String
  message   String
  createdAt DateTime @default(now())

  dispute Dispute @relation(fields: [disputeId], references: [id])
}

model Incident {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  tripId       String    @unique @db.ObjectId
  description  String
  severity     String
  damageImages String[]
  reportedAt   DateTime  @default(now())
  resolvedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
}

// ==================== EARNINGS & SETTLEMENT ====================

model Earning {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  ownerId     String   @db.ObjectId
  bookingId   String?  @db.ObjectId
  amount      Float
  type        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner OwnerProfile @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([createdAt])
}

model Transaction {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  ownerId     String       @db.ObjectId
  owner       OwnerProfile @relation(fields: [ownerId], references: [id])
  amount      Float
  type        String
  status      String       @default("pending")
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([ownerId])
  @@index([status])
}

model Settlement {
  id            String           @id @default(auto()) @map("_id") @db.ObjectId
  ownerId       String?          @db.ObjectId
  period        String
  totalEarnings Float
  totalPayouts  Float
  netAmount     Float
  status        SettlementStatus @default(PENDING)
  processedAt   DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  owner OwnerProfile? @relation(fields: [ownerId], references: [id])

  @@index([ownerId])
  @@index([status])
  @@index([period])
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  type      String
  title     String
  content   String?
  relatedId String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ==================== FILE UPLOADS ====================

model FileUpload {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  fileName   String
  fileUrl    String
  fileType   String
  fileSize   Int
  uploadedBy String?  @db.ObjectId
  uploadedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([uploadedBy])
  @@index([uploadedAt])
}

// ==================== OTP ====================

model OTP {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String
  code      String
  type      String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([expiresAt])
}
