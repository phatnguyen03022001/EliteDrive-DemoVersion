// prisma/schema.prisma - OPTIMIZED & SIMPLIFIED

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  GUEST
  CUSTOMER
  OWNER
  ADMIN
}

enum KYCStatus {
  NONE
  PENDING
  APPROVED
  REJECTED
}

enum BookingStatus {
  PENDING
  APPROVED
  REJECTED
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum TripStatus {
  UPCOMING
  ONGOING
  COMPLETED
}

enum DisputeStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum SettlementStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum CarStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

// ==================== USERS & AUTHENTICATION ====================

model User {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  email      String   @unique
  password   String
  phone      String?
  firstName  String?
  lastName   String?
  avatar     String?
  role       UserRole @default(GUEST)
  isVerified Boolean  @default(false)
  isActive   Boolean  @default(true)

  // ====== CUSTOMER FIELDS ======
  customerLicenseNumber   String?
  customerLicenseExpiry   DateTime?
  customerLicenseFrontUrl String?
  customerLicenseBackUrl  String?
  customerDateOfBirth     DateTime?

  // ====== OWNER FIELDS ======
  ownerCompanyName       String?
  ownerTaxId             String?
  ownerBankAccountName   String?
  ownerBankAccountNumber String?
  ownerBankCode          String?

  // ====== SHARED FIELDS ======
  address            String?
  city               String?
  country            String?
  postalCode         String?
  verificationStatus VerificationStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  kyc               KYC?
  bookings          Booking[]
  payments          Payment[]
  reviews           Review[]
  wallet            Wallet?
  trips             Trip[]
  disputes          Dispute[]
  cars              Car[]
  ownerTransactions OwnerTransaction[]
  settlements       Settlement[]

  @@index([role])
  @@index([verificationStatus])
}

// ==================== KYC & VERIFICATION ====================

model KYC {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  userId           String    @unique @db.ObjectId
  status           KYCStatus @default(NONE)
  documentType     String?
  documentNumber   String?
  documentFrontUrl String?
  documentBackUrl  String?
  faceImageUrl     String?
  verifiedAt       DateTime?
  rejectionReason  String?
  submittedAt      DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
}

// ==================== CARS & VEHICLES ====================

model Car {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  ownerId      String   @db.ObjectId
  name         String
  brand        String
  model        String
  year         Int
  licensePlate String   @unique
  color        String?
  transmission String?
  fuelType     String?
  seatCount    Int
  description  String?
  mainImageUrl String?
  imageUrls    String[]

  // ====== PRICING (GỘP VÀO) ======
  pricePerDay        Float
  pricePerHour       Float?
  pricePerWeek       Float?
  pricePerMonth      Float?
  discountPercentage Float  @default(0)

  categoryId         String?            @db.ObjectId
  locationId         String?            @db.ObjectId
  insurance          Float?
  depositRequired    Float?
  isAvailable        Boolean            @default(true)
  status             CarStatus          @default(DRAFT)
  verificationStatus VerificationStatus @default(PENDING)

  totalTrips    Int   @default(0)
  averageRating Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner        User           @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  category     Category?      @relation(fields: [categoryId], references: [id])
  location     Location?      @relation(fields: [locationId], references: [id])
  documents    CarDocument[]
  availability Availability[]
  bookings     Booking[]
  reviews      Review[]
  trips        Trip[]

  @@index([ownerId])
  @@index([categoryId])
  @@index([locationId])
  @@index([verificationStatus])
}

model CarDocument {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  carId        String    @db.ObjectId
  documentType String
  documentUrl  String
  expiryDate   DateTime?
  uploadedAt   DateTime  @default(now())

  car Car @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@index([carId])
}

model Category {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   @unique
  description String?
  imageUrl    String?
  createdAt   DateTime @default(now())

  cars Car[]
}

model Location {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String   @unique
  address   String
  city      String
  latitude  Float?
  longitude Float?
  createdAt DateTime @default(now())

  cars Car[]
}

// ==================== AVAILABILITY (GỘP CALENDAR) ====================

model Availability {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  carId         String   @db.ObjectId
  date          DateTime
  isAvailable   Boolean  @default(true)
  blockedReason String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  car Car @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@unique([carId, date])
  @@index([carId])
  @@index([date])
}

// ==================== BOOKINGS & TRIPS ====================

model Booking {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  customerId      String        @db.ObjectId
  carId           String        @db.ObjectId
  startDate       DateTime
  endDate         DateTime
  pickupLocation  String?
  dropoffLocation String?
  status          BookingStatus @default(PENDING)
  totalPrice      Float
  insurancePrice  Float?
  depositAmount   Float?
  discountAmount  Float?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  customer User      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  car      Car       @relation(fields: [carId], references: [id], onDelete: Cascade)
  payments Payment[]
  contract Contract?
  trip     Trip?
  disputes Dispute[]

  @@index([customerId])
  @@index([carId])
  @@index([status])
  @@index([startDate])
}

model Trip {
  id         String     @id @default(auto()) @map("_id") @db.ObjectId
  bookingId  String     @unique @db.ObjectId
  customerId String     @db.ObjectId
  carId      String     @db.ObjectId
  status     TripStatus @default(UPCOMING)

  // ====== INCIDENT INFO (GỘP VÀO) ======
  incidentDescription String?
  incidentSeverity    String?
  damageImages        String[]
  incidentReportedAt  DateTime?

  startOdometer  Int?
  endOdometer    Int?
  startFuelLevel Float?
  endFuelLevel   Float?
  checkinTime    DateTime?
  checkoutTime   DateTime?
  pickupNotes    String?
  dropoffNotes   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking  Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customer User    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  car      Car     @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([carId])
  @@index([status])
}

// ==================== PAYMENTS & WALLET ====================

model Payment {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  bookingId     String?       @db.ObjectId
  userId        String        @db.ObjectId
  walletId      String?       @db.ObjectId
  amount        Float
  paymentMethod String
  transactionId String?       @unique
  status        PaymentStatus @default(PENDING)
  paidAt        DateTime?
  refundedAt    DateTime?
  failureReason String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  wallet  Wallet?  @relation(fields: [walletId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([bookingId])
}

model Wallet {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @unique @db.ObjectId
  balance   Float    @default(0)
  currency  String   @default("VND")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]
  payments     Payment[]
}

model WalletTransaction {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  walletId    String   @db.ObjectId
  amount      Float // positive or negative
  type        String // 'ESCROW_HELD', 'RENTAL_INCOME', 'REFUND', 'WITHDRAW_APPROVED', 'PLATFORM_FEE', etc.
  description String?
  metadata    Json? // Store additional data like bookingId, refundPercent
  createdAt   DateTime @default(now())

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([createdAt])
  @@index([type])
}

// ==================== CONTRACTS ====================

model Contract {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  bookingId         String    @unique @db.ObjectId
  content           String?
  customerSignedAt  DateTime?
  customerSignature String?
  ownerSignedAt     DateTime?
  status            String    @default("pending") // 'pending', 'signed', 'completed'
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}

// ==================== REVIEWS & RATINGS ====================

model Review {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  bookingId  String?  @db.ObjectId
  customerId String   @db.ObjectId
  carId      String   @db.ObjectId
  rating     Int
  title      String?
  content    String?
  images     String[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer User @relation(fields: [customerId], references: [id], onDelete: Cascade)
  car      Car  @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([carId])
  @@index([rating])
}

// ==================== PROMOTIONS ====================

model Promotion {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  code             String   @unique
  description      String?
  discountType     String // 'PERCENTAGE', 'FIXED'
  discountValue    Float
  maxUses          Int?
  usedCount        Int      @default(0)
  minBookingAmount Float?
  startDate        DateTime
  endDate          DateTime
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
}

// ==================== DISPUTES ====================

model Dispute {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  bookingId   String?       @db.ObjectId
  initiatedBy String        @db.ObjectId
  title       String
  description String?
  attachments String[]
  status      DisputeStatus @default(OPEN)
  resolution  String?
  resolvedAt  DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  booking         Booking?         @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  initiator       User             @relation(fields: [initiatedBy], references: [id], onDelete: Cascade)
  disputeMessages DisputeMessage[]

  @@index([initiatedBy])
  @@index([status])
  @@index([bookingId])
}

model DisputeMessage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  disputeId String   @db.ObjectId
  senderId  String   @db.ObjectId
  message   String
  createdAt DateTime @default(now())

  dispute Dispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  @@index([disputeId])
  @@index([senderId])
}

// ==================== OWNER TRANSACTIONS (GỘP EARNING + TRANSACTION) ====================

model OwnerTransaction {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  ownerId     String   @db.ObjectId
  bookingId   String?  @db.ObjectId
  amount      Float
  type        String // 'RENTAL_INCOME', 'WITHDRAW', 'WITHDRAW_PENDING', 'PLATFORM_FEE'
  status      String   @default("pending") // 'pending', 'completed', 'failed'
  description String?
  metadata    Json? // Store additional data
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// ==================== SETTLEMENT ====================

model Settlement {
  id            String           @id @default(auto()) @map("_id") @db.ObjectId
  ownerId       String?          @db.ObjectId
  period        String // 'YYYY-MM' format
  totalEarnings Float
  totalPayouts  Float
  netAmount     Float
  status        SettlementStatus @default(PENDING)
  processedAt   DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  owner User? @relation(fields: [ownerId], references: [id], onDelete: SetNull)

  @@index([ownerId])
  @@index([status])
  @@index([period])
}

// ==================== OTP ====================

model OTP {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String
  code      String
  type      String // 'EMAIL_VERIFICATION', 'PASSWORD_RESET', 'PHONE'
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, code])
  @@index([email])
  @@index([expiresAt])
}
